
# Copyright (C) 2014  Oscar Campos <oscar.campos@member.fsf.org>

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

# See LICENSE file for more details.

# usage: workon <environemnt>
function activate {
    environemnt="$1"
    shift
    for i in "$@"; do
        case $i in
            --pre-activate=*)
                pre_activate_script=$(echo "$i" | sed 's/[-a-zA-Z0-9]*=//')
            ;;
            --post-activate=*)
                post_activate_script=$(echo "$i" | sed 's/[-a-zA-Z0-9]*=//')
            ;;
            -h|--help)
                vengo_activate_help
                exit 0
            ;;
            *)
                echo "Invalid option $i"
                vengo_activate_help
                exit 65
            ;;
        esac
    done

    if [ "$environemnt" = "" ]; then
        lsenvs
        return 1
    fi

    check_environment_exixtance $environemnt || return 1

    activate="$VENGO_HOME/$environemnt/bin/activate"
    if [ ! -f "$activate" ]; then
        echo "VenGO: Environment '$VENGO_HOME/$environemnt' doesn't contains an activate script." >&2
        echo "  suggestion: check the integrity of the environments with 'vengo lsenvs'" >&2
        return 1
    fi

    # call deactivate if we are currently into a virtual environment
    type deactivate >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        deactivate
        unset -f deactivate >/dev/null 2>&1
    fi

    if [ -z ${pre_activate_script+x} ]; then
        pre_activate_script "$environment"
    fi

    source "$activate"

    if [ -z ${post_activate_script+x} ]; then
        post_activate_script "$environment"
    fi

    return 0
}
